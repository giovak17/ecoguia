{% extends "usuarios/base.html" %}
{% load static %}

{% block title %}Retos y Recompensas - EcoGuia{% endblock %}

{% block content %}

<div class="cards-container">
  <h2>Retos y Recompensas</h2>
  <p>Consulta los retos y recompensas disponibles para reciclar mejor</p>

  <h3>Retos</h3>
  <div class="cards-grid">
    {% for reto in retos %}
      <div class="card-item" id="card-reto-{{ forloop.counter }}" tabindex="0" 
           onclick="openModal('modal-reto-{{ forloop.counter }}')" onkeypress="if(event.key==='Enter'){openModal('modal-reto-{{ forloop.counter }}')}">
        <h5>{{ reto.titulo }}</h5>
      </div>

      <!-- Modal para reto -->
      <div class="modal-overlay" id="modal-reto-{{ forloop.counter }}">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-reto-{{ forloop.counter }}">
          <div class="modal-custom-header">
            <h5 class="modal-title" id="modal-title-reto-{{ forloop.counter }}">{{ reto.titulo }}</h5>
            <button type="button" class="modal-close-btn" onclick="closeModal('modal-reto-{{ forloop.counter }}')" aria-label="Cerrar modal">✖</button>
          </div>
          <div class="modal-body">
            <p>{{ reto.descripcion|default:"Sin descripción." }}</p>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No hay retos disponibles.</p>
    {% endfor %}
  </div>

  <h3>Recompensas</h3>
  <div class="cards-grid">
    {% for recompensa in recompensas %}
      <div class="card-item" id="card-recompensa-{{ forloop.counter }}" tabindex="0"
           onclick="openModal('modal-recompensa-{{ forloop.counter }}')" onkeypress="if(event.key==='Enter'){openModal('modal-recompensa-{{ forloop.counter }}')}">
        <h5>{{ recompensa.nombre }}</h5>
      </div>

      <!-- Modal para recompensa -->
      <div class="modal-overlay" id="modal-recompensa-{{ forloop.counter }}">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-recompensa-{{ forloop.counter }}">
          <div class="modal-custom-header">
            <h5 class="modal-title" id="modal-title-recompensa-{{ forloop.counter }}">{{ recompensa.nombre }}</h5>
            <button type="button" class="modal-close-btn" onclick="closeModal('modal-recompensa-{{ forloop.counter }}')" aria-label="Cerrar modal">✖</button>
          </div>
          <div class="modal-body">
            <p><strong>Puntos requeridos:</strong> {{ recompensa.puntos_requeridos }}</p>
            <p>{{ recompensa.descripcion|default:"Sin descripción." }}</p>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No hay recompensas disponibles.</p>
    {% endfor %}
  </div>
</div>

<script>
// Abrir modal
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    modal.querySelector('.modal').focus();
  }
}

// Cerrar modal
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }
}

// Cerrar modal al hacer click fuera del contenido
document.addEventListener('click', function(event){
  document.querySelectorAll('.modal-overlay.active').forEach(modal => {
    if(event.target === modal) {
      closeModal(modal.id);
    }
  });
});

// Cerrar modal con Escape
document.addEventListener('keydown', function(event) {
  if(event.key === "Escape") {
    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
      closeModal(modal.id);
    });
  }
});
</script>

<style>
:root {
  --font-main: 'Poppins', sans-serif;
  --color-bg: #f5faf7;
  --color-primary: #2f5d3a; /* verde oscuro */
  --color-primary-light: #a9cbb7; /* verde suave */
  --color-secondary: #597d54; /* verde medio */
  --color-accent: #3f704d; 
  --color-modal-bg: #ffffff;
  --color-text: #1b3620;
  --shadow-soft: rgba(47,93,58,0.15);
}

.cards-container {
  max-width: 1100px;
  margin: 8rem auto 2rem; 
  padding: 0 1rem;
  font-family: var(--font-main);
  color: var(--color-text);
  user-select: none;
}

.cards-container h2 {
  text-align: center;
  font-weight: 700;
  font-size: 2.2rem;
  margin-bottom: 0.25rem;
  color: var(--color-primary);
}

.cards-container p {
  text-align: center;
  margin-bottom: 2rem;
  font-weight: 500;
  color: var(--color-secondary);
}

h3 {
  margin: 1.5rem 0 0.75rem;
  color: var(--color-accent);
  font-weight: 600;
  font-size: 1.6rem;
  border-bottom: 2px solid var(--color-primary-light);
  padding-bottom: 0.25rem;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
  gap: 1.2rem;
}

.card-item {
  background: var(--color-primary-light);
  border-radius: 1rem;
  box-shadow: 0 3px 6px var(--shadow-soft);
  padding: 1.2rem;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  text-align: center;
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--color-primary);
  user-select: none;
}

.card-item:hover,
.card-item:focus {
  background: var(--color-primary-light);
  box-shadow: 0 6px 16px var(--shadow-soft);
  transform: scale(1.05);
  outline: none;
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.45);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  overflow-y: auto;
  padding: 1rem;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--color-modal-bg);
  border-radius: 1rem;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  box-shadow: 0 10px 30px var(--shadow-soft);
  display: flex;
  flex-direction: column;
  outline: none;
}

.modal-custom-header {
  background: var(--color-primary);
  color: white;
  border-radius: 1rem 1rem 0 0;
  padding: 1.5rem 1rem;
  font-weight: 700;
  font-size: 1.3rem;
  text-align: center;
  position: relative;
}

.modal-close-btn {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: white;
  font-size: 1.3rem;
  cursor: pointer;
  padding: 0;
}

.modal-body {
  padding: 1.5rem 1.5rem 2rem;
  color: var(--color-text);
  font-size: 1rem;
  overflow-y: auto;
}

@media (max-width: 650px) {
  .cards-grid {
    grid-template-columns: 1fr;
  }
}
</style>

{% endblock %}
